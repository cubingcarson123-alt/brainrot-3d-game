<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Maze Escape 2</title>
<style>
html,body{margin:0;overflow:hidden;background:#000}
canvas{display:block}

#menu,#win,#scare{
 position:fixed;inset:0;
 display:flex;align-items:center;justify-content:center;
 background:#000;color:#fff;font-family:sans-serif;
 z-index:10
}

#menu button{
 font-size:28px;padding:14px 36px;cursor:pointer
}

#meter{
 position:fixed;bottom:20px;left:50%;
 transform:translateX(-50%);
 width:320px;height:14px;border:2px solid #fff;
 z-index:5
}
#fill{height:100%;width:0;background:red}

#win,#scare{display:none;font-size:60px}
</style>
</head>
<body>

<div id="menu"><button>START</button></div>
<div id="win">YOU ESCAPED ðŸŽ‰</div>
<div id="scare">ðŸ‘¹</div>
<div id="meter"><div id="fill"></div></div>

<canvas id="c"></canvas>

<script>
/* ================= SETUP ================= */
const c=document.getElementById("c"),ctx=c.getContext("2d");
resize();addEventListener("resize",resize);
function resize(){c.width=innerWidth;c.height=innerHeight}

/* ================= MAZE ================= */
const map=[
"############################",
"#............#.............#",
"#.######.#####.#.######.###.#",
"#.#....#.....#.#.#....#...#.#",
"#.#.##.#####.#.#.#.##.#####.#",
"#.#.#....#.#.#.#.#.#....#.#.#",
"#.#.######.#.#.#.#.######.#.#",
"#...#........#...#........#.#",
"###.#.###################.#.#",
"#.................#........E#",
"############################"
];

/* ================= PLAYER ================= */
let p={x:1.5,y:1.5,a:0};
let W=false,locked=false;

/* ================= CPU (VISIBLE) ================= */
let cpu={
 x:14.5,y:6.5,
 a:Math.random()*Math.PI*2,
 s:0.01
};

/* ================= STATE ================= */
let danger=0,dead=false,won=false;

/* ================= INPUT ================= */
onkeydown=e=>{if(e.key==="w")W=true}
onkeyup=e=>{if(e.key==="w")W=false}

c.onclick=()=>c.requestPointerLock();
document.onpointerlockchange=()=>locked=document.pointerLockElement===c;
document.onmousemove=e=>{
 if(!locked)return;
 p.a-=e.movementX*0.00025; // FIXED SENSITIVITY
};

/* ================= HELPERS ================= */
function tile(x,y){
 return map[Math.floor(y)]?.[Math.floor(x)];
}
function wall(x,y){return tile(x,y)==="#"}

/* ================= UPDATE ================= */
function update(){
 if(dead||won)return;

 // Player move
 if(W){
  let nx=p.x+Math.cos(p.a)*0.045;
  let ny=p.y+Math.sin(p.a)*0.045;
  if(!wall(nx,p.y))p.x=nx;
  if(!wall(p.x,ny))p.y=ny;
 }

 // Exit
 if(tile(p.x,p.y)==="E"){
  won=true;
  document.exitPointerLock();
  document.getElementById("win").style.display="flex";
 }

 // CPU roaming (always visible)
 let nx=cpu.x+Math.cos(cpu.a)*cpu.s;
 let ny=cpu.y+Math.sin(cpu.a)*cpu.s;
 if(wall(nx,ny)){
  cpu.a=Math.random()*Math.PI*2;
 }else{
  cpu.x=nx;cpu.y=ny;
 }

 // Danger meter
 let d=Math.hypot(p.x-cpu.x,p.y-cpu.y);
 danger=Math.min(100,100-d*8);
 document.getElementById("fill").style.width=danger+"%";

 if(d<0.5){
  dead=true;
  document.exitPointerLock();
  document.getElementById("scare").style.display="flex";
 }
}

/* ================= RENDER ================= */
function render(){
 ctx.fillStyle="#000";
 ctx.fillRect(0,0,c.width,c.height);

 const fov=Math.PI/3;

 for(let i=0;i<c.width;i++){
  let ra=p.a-fov/2+i/c.width*fov;
  let dist=0,hitCPU=false,hitExit=false;

  while(dist<30){
   dist+=0.025;
   let rx=p.x+Math.cos(ra)*dist;
   let ry=p.y+Math.sin(ra)*dist;

   if(Math.hypot(rx-cpu.x,ry-cpu.y)<0.7){hitCPU=true;break;}
   if(tile(rx,ry)==="E"){hitExit=true;break;}
   if(wall(rx,ry))break;
  }

  let h=c.height/(dist*0.6);

  if(hitCPU) ctx.fillStyle="red";       // CPU CLEAR
  else if(hitExit) ctx.fillStyle="lime";// EXIT CLEAR
  else{
   let s=200-dist*15;
   ctx.fillStyle=`rgb(${s},${s},${s})`;
  }

  ctx.fillRect(i,(c.height-h)/2,1,h);
 }
}

/* ================= LOOP ================= */
function loop(){
 update();
 render();
 requestAnimationFrame(loop);
}

/* ================= MENU ================= */
document.querySelector("button").onclick=()=>{
 document.getElementById("menu").style.display="none";
 c.requestPointerLock();
 loop();
};
</script>
</body>
</html>
