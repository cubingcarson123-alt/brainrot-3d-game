<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tung Tung Sahur</title>
<style>
body { margin:0; overflow:hidden; background:black }

#bar {
  position:fixed; bottom:20px; left:50%;
  transform:translateX(-50%);
  width:300px; height:14px;
  border:2px solid white; background:#333;
}
#barInner { height:100%; width:0%; background:red; }

#map {
  position:fixed; top:10px; right:10px;
  width:160px; height:160px;
  background:#111; border:2px solid white;
}

#jumpscare {
  position:fixed; inset:0;
  background:black; display:none;
  align-items:center; justify-content:center;
  z-index:10;
}

#face {
  width:400px; height:600px;
  background:#d2b48c;
  border-radius:40px;
  position:relative;
  animation:slam 0.4s infinite alternate;
}

.eye {
  width:80px; height:80px;
  background:white; border-radius:50%;
  position:absolute; top:120px;
}
.eye::after {
  content:""; position:absolute;
  inset:25px; background:black;
  border-radius:50%;
}
#eyeL { left:80px }
#eyeR { right:80px }

#smile {
  position:absolute;
  width:200px; height:30px;
  background:black;
  bottom:160px; left:100px;
  border-radius:0 0 50px 50px;
}

@keyframes slam {
  from { transform:scale(1) }
  to { transform:scale(1.15) }
}
</style>
</head>
<body>

<div id="bar"><div id="barInner"></div></div>
<canvas id="map"></canvas>

<div id="jumpscare">
  <div id="face">
    <div class="eye" id="eyeL"></div>
    <div class="eye" id="eyeR"></div>
    <div id="smile"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
/* ---------- SCENE ---------- */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x000000);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

/* ---------- FLOOR ---------- */
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshStandardMaterial({color:0x3344ff})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

/* ---------- MAZE ---------- */
const CELL=5;
const maze=[
"####################",
"#S     #        #  #",
"# ### ### ###### # #",
"#   #     #      # #",
"### ##### # ###### #",
"#       # #        #",
"# ##### # ###### ###",
"#     # #        # #",
"# ### # ######## # #",
"#   # #        E # #",
"####################"
];

const walls=[];
let exitPos=null;

maze.forEach((row,z)=>{
  [...row].forEach((c,x)=>{
    if(c==="#"){
      const w=new THREE.Mesh(
        new THREE.BoxGeometry(CELL,3,CELL),
        new THREE.MeshStandardMaterial({color:0x7faaff})
      );
      w.position.set(x*CELL,1.5,z*CELL);
      scene.add(w); walls.push(w);
    }
    if(c==="S") camera.position.set(x*CELL,1.6,z*CELL);
    if(c==="E") exitPos=new THREE.Vector3(x*CELL,1,z*CELL);
  });
});

/* ---------- EXIT (CLEAR) ---------- */
const exit=new THREE.Mesh(
  new THREE.BoxGeometry(3,4,1),
  new THREE.MeshStandardMaterial({color:0x00ff00, emissive:0x00ff00})
);
exit.position.copy(exitPos);
exit.position.y=2;
scene.add(exit);

/* ---------- COLLISION ---------- */
const R=0.7;
function blocked(p){
  return walls.some(w =>
    Math.abs(p.x-w.position.x)<CELL/2+R &&
    Math.abs(p.z-w.position.z)<CELL/2+R
  );
}

/* ---------- CONTROLS ---------- */
let yaw=0,velY=0,onGround=true;
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* ---------- ENEMY (TUNG TUNG SHAPE) ---------- */
const enemy=new THREE.Group();

// tall body
const body=new THREE.Mesh(
  new THREE.BoxGeometry(1.5,3,1.2),
  new THREE.MeshStandardMaterial({color:0xd2b48c})
);
body.position.y=1.8;
enemy.add(body);

// legs
for(let i=-0.4;i<=0.4;i+=0.8){
  const leg=new THREE.Mesh(
    new THREE.BoxGeometry(0.3,1.2,0.3),
    new THREE.MeshStandardMaterial({color:0xd2b48c})
  );
  leg.position.set(i,0.6,0);
  enemy.add(leg);
}

// face
const eyeMat=new THREE.MeshBasicMaterial({color:0x000000});
const e1=new THREE.Mesh(new THREE.SphereGeometry(0.15),eyeMat);
const e2=e1.clone();
e1.position.set(-0.3,2.4,0.61);
e2.position.set(0.3,2.4,0.61);
enemy.add(e1,e2);

const smile=new THREE.Mesh(
  new THREE.BoxGeometry(0.7,0.15,0.01),eyeMat
);
smile.position.set(0,2.1,0.61);
enemy.add(smile);

enemy.position.set(6*CELL,0,7*CELL);
scene.add(enemy);

/* ---------- MAP ---------- */
const map=document.getElementById("map");
const ctx=map.getContext("2d");

function drawMap(){
  ctx.clearRect(0,0,160,160);
  maze.forEach((r,z)=>{
    [...r].forEach((c,x)=>{
      if(c==="#"){
        ctx.fillStyle="#555";
        ctx.fillRect(x*8,z*8,8,8);
      }
    });
  });
  ctx.fillStyle="green";
  ctx.fillRect(camera.position.x/CELL*8,camera.position.z/CELL*8,4,4);
  ctx.fillStyle="red";
  ctx.fillRect(enemy.position.x/CELL*8,enemy.position.z/CELL*8,4,4);
}

/* ---------- LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);

  if(keys["arrowleft"]) yaw+=0.04;
  if(keys["arrowright"]) yaw-=0.04;
  camera.rotation.y=yaw;

  const f=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
  let next=camera.position.clone();
  if(keys["w"]) next.add(f.clone().multiplyScalar(0.14));
  if(keys["s"]) next.add(f.clone().multiplyScalar(-0.14));
  if(!blocked(next)) camera.position.copy(next);

  if(keys[" "] && onGround){ velY=0.3; onGround=false; }
  velY-=0.015;
  camera.position.y+=velY;
  if(camera.position.y<1.6){ camera.position.y=1.6; velY=0; onGround=true; }

  const dist=camera.position.distanceTo(enemy.position);
  const dir=camera.position.clone().sub(enemy.position).normalize();
  const enext=enemy.position.clone().add(dir.multiplyScalar(0.06));
  if(!blocked(enext)) enemy.position.copy(enext);

  document.getElementById("barInner").style.width=Math.max(0,100-dist*7)+"%";

  if(dist<1.4){
    document.getElementById("jumpscare").style.display="flex";
    setTimeout(()=>location.reload(),900);
  }

  if(camera.position.distanceTo(exit.position)<1.5){
    document.body.innerHTML="<h1 style='color:white;text-align:center;margin-top:40vh'>YOU ESCAPED ðŸŽ‰</h1>";
  }

  drawMap();
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
